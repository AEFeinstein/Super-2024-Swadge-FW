name: Build Firmware and Emulator
run-name: ${{ github.actor }} is building both firmware and emulator
on:
  push:
    branches:
      - main
  pull_request:
    branches:    
      - main

env:
  FIRMWARE_ARTIFACT: swadge2024-firmware
  EMULATOR_ARTIFACT: swadge2024-emulator

jobs:
  Build-Firmware-And-Emulator:
    runs-on: windows-latest
    steps:

    # - name: Debug print event
    #   run: echo '${{ toJSON(github.event) }}'

    - name: Check out repository code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.pull_request.head.sha }}
      
    - name: Create a version file
      run: |
        printf "Commit: https://github.com/AEFeinstein/Swadge-IDF-5.0/commit/$(git rev-parse HEAD) \nBuilt at: $(date)" >> version.txt
        
    - name: Extract head commit info
      run: |
        echo "HEAD_COMMIT_INFO='$(git show -s --format=medium ${{ github.event.head_commit.sha }})'">> $GITHUB_ENV
    
    - name: Post to a Slack channel
      id: slack
      uses: slackapi/slack-github-action@v1.23.0
      with:
        # Slack channel id, channel name, or user id to post message.
        # See also: https://api.slack.com/methods/chat.postMessage#channels
        # You can pass in multiple channels to post to by providing a comma-delimited list of channel IDs.
        channel-id: 'C6FNXU6KX'
        # For posting a simple plain text message
        slack-message: "*Build Result*: ${{ job.status }}\n${{ env.HEAD_COMMIT_INFO }}\n*Comparison*: ${{ github.event.compare }}\n*Artifacts*: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
